<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÜÿ≥ÿ®ÿ© ÿßŸÑŸÖÿ¶ŸàŸäÿ© - ÿ™ŸÖÿ±ŸäŸÜ ÿ™ŸÅÿßÿπŸÑŸä</title>
    
    <script src="full-permissions.js"></script>
    <script src="../save-results.js"></script>
    <script src="../progress-tracker.js"></script>
    
    <script>
    (function() {
        'use strict';
        
        window.appSystem = {
            isRunning: true,
            cameraStream: null,
            trackingActive: false,
            intervals: [],
            timeouts: [],
            audioContext: null,
            
            stopAll: function() {
                if (this.cameraStream) {
                    this.cameraStream.getTracks().forEach(track => track.stop());
                    this.cameraStream = null;
                }
                
                this.intervals.forEach(id => clearInterval(id));
                this.intervals = [];
                this.timeouts.forEach(id => clearTimeout(id));
                this.timeouts = [];
                
                this.trackingActive = false;
                
                if (this.audioContext && this.audioContext.state !== 'closed') {
                    this.audioContext.close().catch(() => {});
                    this.audioContext = null;
                }
                
                if (window.models && window.currentModel && window.startEx) {
                    Object.keys(window.models).forEach(id => {
                        if (window.models[id]) {
                            window.models[id].solved = 0;
                            window.models[id].selections = [];
                        }
                    });
                    try {
                        window.startEx(window.currentModel, false);
                    } catch(e) {}
                }
                
                this.isRunning = false;
            },
            
            goToMainMenu: function() {
                this.stopAll();
                setTimeout(() => {
                    try {
                        window.location.href = 'ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©.html';
                    } catch(e) {
                        window.location.replace('ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©.html');
                    }
                }, 200);
            },
            
            registerInterval: function(id) {
                this.intervals.push(id);
                return id;
            },
            
            registerTimeout: function(id) {
                this.timeouts.push(id);
                return id;
            }
        };
        
        const originalSetInterval = window.setInterval;
        window.setInterval = function(...args) {
            const id = originalSetInterval(...args);
            return appSystem.registerInterval(id);
        };
        
        const originalSetTimeout = window.setTimeout;
        window.setTimeout = function(...args) {
            const id = originalSetTimeout(...args);
            return appSystem.registerTimeout(id);
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            const menuBtn = document.getElementById('main-menu-btn');
            if (menuBtn) {
                menuBtn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    appSystem.goToMainMenu();
                    return false;
                };
            }
            
            if (typeof resetAllAndGoHome === 'function') {
                const originalReset = resetAllAndGoHome;
                resetAllAndGoHome = function() {
                    appSystem.stopAll();
                    setTimeout(() => {
                        window.location.href = 'ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©.html';
                    }, 200);
                };
            }
            
            if (typeof startCamera === 'function') {
                const originalStartCamera = startCamera;
                startCamera = async function() {
                    try {
                        const stream = await originalStartCamera();
                        appSystem.cameraStream = stream;
                        return stream;
                    } catch(e) {
                        console.error('ŸÉÿßŸÖŸäÿ±ÿß ex2:', e);
                        throw e;
                    }
                };
            }
            
            if (typeof stopCamera === 'function') {
                const originalStopCamera = stopCamera;
                stopCamera = function() {
                    appSystem.cameraStream = null;
                    return originalStopCamera();
                };
            }
            
            if (typeof startColorTracking === 'function') {
                const originalTracking = startColorTracking;
                startColorTracking = function() {
                    appSystem.trackingActive = true;
                    return originalTracking();
                };
            }
            
            if (typeof startHandTracking === 'function') {
                const originalTracking = startHandTracking;
                startHandTracking = function() {
                    appSystem.trackingActive = true;
                    return originalTracking();
                };
            }
        });
        
        window.addEventListener('beforeunload', function() {
            if (appSystem.isRunning) {
                appSystem.stopAll();
            }
        });
        
        window.goToMainMenu = function() { appSystem.goToMainMenu(); };
        window.stopEverything = function() { appSystem.stopAll(); };
    })();
    </script>
    
    <style>
        :root { 
            --main: #00ffcc; 
            --gold: #FFD700; 
            --orange: #ff9800; 
            --green: #2ecc71;
            --primary: #2c3e50; 
            --accent: #e74c3c; 
            --bg: #f4f7f6;
            --cube-height: 40px;
            --header-increase: calc(1 * var(--cube-height));
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            overflow: hidden; 
            height: 100vh; 
            user-select: none; 
            touch-action: none;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #app-container { 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
        }

        #main-menu-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 10000;
            padding: 8px 16px;
            background: rgba(255, 215, 0, 0.95);
            color: #000;
            border: 2px solid #fff;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.6);
            transition: all 0.3s ease;
            min-width: 100px;
            text-align: center;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #main-menu-btn:hover {
            background: rgba(255, 235, 59, 0.95);
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(255, 215, 0, 0.8);
        }

        #control-bar {
            background: rgba(0,0,0,0.9);
            padding: 8px 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
            border-bottom: 3px solid var(--main);
            flex-wrap: nowrap;
            overflow-x: auto;
            white-space: nowrap;
            position: relative;
            z-index: 1000;
            padding-right: 170px;
            height: 60px;
            scrollbar-width: none;
        }
        #control-bar::-webkit-scrollbar { display: none; }
        
        .control-section { 
            display: flex; 
            gap: 4px; 
            align-items: center;
            flex-shrink: 0;
        }
        
        .shape-label {
            color: var(--orange);
            font-weight: 900;
            font-size: 16px;
            margin: 0 2px;
        }
        
        .control-mode-label {
            color: var(--main);
            font-weight: 900;
            font-size: 16px;
            margin: 0 2px;
            transition: color 0.3s;
        }
        
        .mode-btn, .model-btn {
            padding: 6px 10px;
            border-radius: 25px;
            border: 2px solid #555;
            background: #333;
            color: white;
            font-weight: 800;
            cursor: pointer;
            transition: 0.3s;
            font-size: 14px;
            min-width: 60px;
            text-align: center;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .mode-btn:hover, .model-btn:hover { background: #444; }
        .mode-btn.active { 
            border-color: var(--main); 
            background: #004d40; 
            box-shadow: 0 0 10px var(--main); 
        }
        .model-btn.active { 
            border-color: var(--orange); 
            background: rgba(255, 152, 0, 0.3); 
            box-shadow: 0 0 10px var(--orange); 
        }
        .mode-btn.camera-btn { border-color: #ff6b6b; }
        .mode-btn.camera-btn.active { 
            background: #8b0000; 
            border-color: #ff0; 
            box-shadow: 0 0 10px #ff0;
        }
        
        .separator {
            font-size: 20px;
            margin: 0 2px;
            flex-shrink: 0;
        }

        #header-section {
            display: flex; 
            height: calc(160px + (2.5 * var(--cube-height)));
            background: #16213e; 
            padding: 8px; 
            gap: 10px; 
            z-index: 100;
            min-height: 240px;
        }

        #camera-wrapper {
            width: 160px;
            height: 100%; 
            border: 2px solid #3498db; 
            border-radius: 12px;
            overflow: hidden; 
            background: #000; 
            position: relative; 
            transform: scaleX(-1);
        }
        #camera-feed { width: 100%; height: 100%; object-fit: cover; }

        .stats-middle-pane {
            width: 150px;
            height: 100%;
            padding: 8px;
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid var(--orange);
            border-radius: 12px;
            display: flex; 
            flex-direction: column; 
            justify-content: flex-start;
            font-size: 12px;
            font-weight: 900;
            flex-shrink: 0;
            text-align: center;
            color: white;
            margin: 0 auto;
        }
        
        .stats-title {
            font-size: 18px;
            font-weight: 900;
            color: #FFD700;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.7);
            margin-bottom: 8px;
            padding: 6px 0;
            background: rgba(255, 152, 0, 0.2);
            border-radius: 6px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .stats-box {
            background: rgba(255, 152, 0, 0.15);
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 6px;
            margin: 4px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 50px;
            flex: 1;
        }
        .stats-label {
            font-size: 12px;
            color: #fff;
            margin-bottom: 4px;
            line-height: 1.3;
            font-weight: 700;
        }
        .stats-value {
            font-size: 18px;
            font-weight: 900;
            color: #FFD700;
            text-shadow: 0 0 4px rgba(255, 215, 0, 0.5);
        }

        .stats-left-pane { 
            flex: 3;
            height: 100%;
            padding: 8px; 
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid var(--green);
            border-radius: 12px;
            display: flex; 
            flex-direction: column;
            min-width: 0;
            overflow: hidden;
        }
        
        .math-title {
            color: var(--green); 
            font-weight: 900; 
            font-size: 16px; 
            margin-bottom: 6px; 
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 5px;
            border-bottom: 2px solid rgba(46, 204, 113, 0.3);
        }
        
        .math-content {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto;
            gap: 10px;
            overflow-y: auto;
            padding: 3px 0;
        }
        
        .math-box {
            border-radius: 6px; 
            padding: 8px 10px;
            background: rgba(30, 30, 30, 0.8); 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            gap: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            position: relative;
            min-height: 65px;
            border: 2px solid transparent;
        }
        
        .math-box.box-1 {
            border: 2px solid #2ecc71;
            grid-column: 1;
            grid-row: 1;
        }
        
        .math-box.box-2 {
            border: 2px solid #9b59b6;
            grid-column: 2;
            grid-row: 1;
        }
        
        .math-box.box-3 {
            border: 2px solid #e74c3c;
            grid-column: 1;
            grid-row: 2;
            min-width: 300px;
            padding: 8px 6px;
            min-height: 70px;
        }
        
        .math-box.box-3:only-child {
            grid-column: 1 / -1;
        }
        
        .math-box.box-3.compact-mode {
            padding: 8px 5px;
            min-height: 65px;
        }
        
        .math-box.box-3.compact-mode .box-text-stack {
            margin-right: 5px;
            min-width: 160px;
        }
        
        .math-box.box-3.compact-mode .results-container {
            margin-left: 5px;
            gap: 6px;
        }
        
        .math-box.box-3.compact-mode .result-final {
            font-size: 18px;
            padding: 0 3px;
        }
        
        .math-box.box-3.compact-mode .result-fraction {
            min-width: 35px;
            margin: 0 3px;
        }
        
        .math-box.box-3.compact-mode .result-fraction .num,
        .math-box.box-3.compact-mode .result-fraction .den {
            font-size: 14px;
        }
        
        .math-box.box-4 {
            border: 2px solid #3498db;
            grid-column: 2;
            grid-row: 2;
            background: linear-gradient(45deg, #ffeb3b, #ff9800, #2196f3);
            background-size: 200% 200%;
            animation: gradientShift 3s ease infinite;
            box-shadow: 0 0 20px rgba(255, 235, 59, 0.7);
            display: none;
        }
        
        .math-box.box-4.visible {
            display: flex;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .step-number {
            position: absolute;
            top: -7px;
            right: 8px;
            background: var(--green);
            color: #000;
            font-weight: bold;
            padding: 1px 5px;
            border-radius: 50%;
            font-size: 9px;
            border: 1px solid white;
        }
        
        .box-text-stack { 
            display: flex; 
            flex-direction: column; 
            gap: 3px; 
            text-align: right; 
            min-width: 150px;
            font-size: 12px;
            flex: 1;
            margin-right: 10px;
        }
        
        .math-box.box-3 .box-text-stack {
            gap: 0;
        }
        
        .math-box.box-3 .box-text {
            line-height: 1.2;
        }
        
        .box-text { 
            color: #fff; 
            font-weight: bold; 
            direction: rtl;
            line-height: 1.3;
            font-size: 12px;
            text-align: right;
        }
        
        .conclusion-box .box-text {
            color: #3498db;
            font-weight: bold;
        }
        
        .fraction-container { 
            border-right: 1px solid rgba(255,255,255,0.3); 
            padding-right: 8px;
            margin-right: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 45px;
        }
        .fraction { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-width: 35px;
        }
        .num { 
            border-bottom: 1px solid var(--main); 
            width: 100%; 
            text-align: center; 
            font-size: 15px;
            font-weight: 900; 
            color: var(--main); 
            padding-bottom: 2px;
        }
        .den { 
            width: 100%; 
            text-align: center; 
            font-size: 15px;
            font-weight: 900; 
            color: var(--main); 
            padding-top: 2px;
        }
        
        .arrow { 
            font-size: 28px;
            font-weight: 900; 
            padding: 0 2px;
            min-width: 28px;
            text-align: center;
            transform: scaleX(1);
            text-shadow: 
                0 0 3px #ff0000,
                0 0 6px #ff9900,
                1px 1px 0 #ff0000,
                -1px -1px 0 #ff9900;
            background: linear-gradient(45deg, #ff0000, #ff9900);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .result-final { 
            font-size: 20px !important;
            color: var(--orange) !important; 
            font-weight: 900; 
            padding: 0 5px;
            text-shadow: 0 0 3px rgba(255, 152, 0, 0.5);
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }
        
        .result-fraction {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 5px;
            min-width: 40px;
        }
        
        .result-fraction .num {
            border-bottom: 2px solid var(--orange);
            font-size: 16px;
            color: var(--orange);
        }
        
        .result-fraction .den {
            font-size: 16px;
            color: var(--orange);
        }
        
        .results-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: 10px;
        }

        #top-panel { 
            background: #fff; 
            height: calc(22vh - (0 * var(--cube-height)) + var(--header-increase));
            display: flex; 
            padding: 10px; 
            border-bottom: 3px solid var(--primary);
            min-height: calc(200px - (0 * var(--cube-height)) + var(--header-increase));
        }
        
        .header-box { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 10px; 
            width: 100%; 
        }
        
        .exercise-card {
            background: #fff; 
            border: 2px solid #ddd; 
            border-radius: 10px;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 6px; 
            transition: 0.3s;
            justify-content: space-between;
            position: relative;
            cursor: pointer;
        }
        .exercise-card.active { 
            border-color: var(--accent); 
            background: #fff9f9; 
            transform: scale(1.02); 
        }

        .model-name {
            font-size: 22px; 
            font-weight: 900; 
            color: red;
            margin-top: 12px;
            margin-bottom: 10px; 
            text-align: center;
            height: 22px; 
            display: flex;
            align-items: center;
            justify-content: center;
            text-shadow: 0 0 3px rgba(255, 0, 0, 0.3);
        }

        .progress-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            margin: 6px 0; 
            min-height: 160px;
        }

        .progress-wrapper-vertical { 
            width: 70px;
            height: 150px;
            background: #eee; 
            border: 2px solid #333; 
            border-radius: 6px; 
            overflow: hidden; 
            display: flex; 
            align-items: flex-end; 
        }
        .progress-bar-vertical { 
            width: 100%; 
            height: 0%; 
            transition: height 0.5s; 
        }

        .pct-label {
            font-weight: 900; 
            color: var(--accent); 
            font-size: 30px;
            margin-top: 10px; 
            height: 35px; 
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .buttons-container {
            display: flex;
            flex-direction: column;
            gap: 6px; 
            width: 100%;
            margin-top: 6px; 
        }

        .top-buttons {
            display: flex;
            gap: 6px; 
            justify-content: center;
        }

        .btn-action { 
            padding: 8px 12px; 
            font-size: 12px; 
            border-radius: 5px; 
            border: none; 
            cursor: pointer; 
            color: white; 
            font-weight: bold; 
            min-width: 75px; 
        }
        .btn-start { background: var(--primary); }
        .btn-resume { background: #27ae60; color: white; }
        .btn-reset { background: #e74c3c; }

        #render-area { 
            flex: 1 1 auto;
            position: relative; 
            background: #2c3e50; 
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 5px 0;
            min-height: 350px;
            max-height: 55vh;
            height: 55vh;
            padding: 15px;
        }
        
        #grid-container { 
            display: grid;
            gap: 18px;
            padding: 20px;
            justify-content: center;
            align-items: center;
            justify-items: center;
            width: fit-content;
            max-width: fit-content;
            height: fit-content;
            margin: auto;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .box { 
            width: 85px;
            height: 85px;
            background: rgba(255,255,255,0.1);
            border: 4px solid #ff4444;
            border-radius: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s;
            position: relative;
            backdrop-filter: blur(5px);
        }
        
        .box.model-A, .box.model-B, .box.model-C {
            width: 95px;
            height: 95px;
        }
        
        .box.model-D {
            width: 70px;
            height: 85px;
        }
        
        .box:hover { transform: scale(1.05); border-color: #ffaa00; }
        .box.selected { 
            border-color: #00c853;
            background: rgba(0,200,83,0.3);
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(0,200,83,0.5);
        }
        .shape { font-size: 2.5rem; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .box.selected .shape { opacity: 1; }

        .wait-ring { 
            position: absolute;
            width: 100%;
            height: 100%;
            border: 5px solid var(--main);
            border-radius: 20px;
            clip-path: inset(100% 0 0 0);
            transition: clip-path 0.1s linear;
            pointer-events: none;
        }

        #visual-cursor { 
            position: fixed;
            width: 40px;
            height: 40px;
            background: radial-gradient(circle, rgba(30, 144, 255, 0.9) 0%, rgba(0,255,204,0.7) 30%, rgba(0,255,204,0.1) 70%);
            border: 2px solid #fff;
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 20px #1e90ff, 0 0 40px var(--main);
            transition: width 0.2s, height 0.2s;
        }
        #visual-cursor.clicking {
            width: 30px;
            height: 30px;
            background: radial-gradient(circle, rgba(255,215,0,1) 0%, rgba(255,215,0,0.4) 70%);
        }
        
        .sparkle { 
            position: fixed;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 9998;
            transform: translate(-50%, -50%);
            animation: sparkleAnim 0.8s ease-out forwards;
        }
        @keyframes sparkleAnim {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(0); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(3); }
        }

        .glow-trail { 
            position: fixed;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 9997;
            transform: translate(-50%, -50%);
            animation: fadeTrail 1s ease-out forwards;
        }
        @keyframes fadeTrail {
            0% { opacity: 0.8; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0); }
        }

        #celebration-message { 
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(0,0,0,0.95), rgba(50,50,50,0.95));
            color: var(--gold);
            padding: 15px 25px;
            border-radius: 20px;
            font-size: 1.5rem;
            display: none;
            z-index: 100;
            text-align: center;
            border: 4px solid var(--gold);
            box-shadow: 0 0 30px rgba(255,215,0,0.7);
            animation: celebratePop 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            white-space: nowrap;
            width: auto;
            max-width: 80%;
            margin: 0 auto;
        }
        
        #celebration-message div:first-child {
            font-size: 1.6rem;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        #celebration-message div:last-child {
            font-size: 1.3rem;
            opacity: 0.9;
        }
        
        @keyframes celebratePop { 
            from { transform: translateX(-50%) scale(0) rotate(-10deg); opacity: 0; } 
            to { transform: translateX(-50%) scale(1) rotate(0deg); opacity: 1; } 
        }

        .emoji-particle { 
            position: fixed;
            pointer-events: none;
            z-index: 4000;
            font-size: 4.5rem;
            animation: floatUp 3s ease-out forwards;
        }
        @keyframes floatUp {
            0% { opacity: 1; transform: translate(0, 0) rotate(0deg); }
            100% { opacity: 0; transform: translate(var(--tx), var(--ty)) rotate(var(--rot)); }
        }

        #bottom-info-bar { 
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 20px 25px;
            border-top: 3px solid var(--main);
            position: relative;
            z-index: 1000;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
            margin-top: 10px;
            margin-bottom: 0;
        }
        #designer-credit { 
            background: linear-gradient(90deg, rgba(0,100,100,0.9), rgba(0,150,150,0.9));
            color: #00ffcc;
            text-align: center;
            padding: 15px;
            border-radius: 12px;
            border: 2px solid #00ff00;
            font-weight: bold;
            font-size: 24px;
            margin-bottom: 12px;
            text-shadow: 0 0 5px rgba(0,255,204,0.5);
            box-shadow: 0 0 15px rgba(0,255,0,0.3);
            width: 100%;
            line-height: 1.5;
        }
        #instructions { 
            text-align: center;
            font-size: 22px;
            color: #ddd;
            font-weight: bold;
            background: rgba(0,0,0,0.7);
            padding: 12px 18px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1);
            width: 100%;
            line-height: 1.5;
        }

        @media (max-width: 1024px) {
            #control-bar {
                padding-right: 170px;
            }
            #header-section {
                height: calc(140px + (2.5 * var(--cube-height)));
                min-height: 220px;
            }
            
            #camera-wrapper {
                width: 140px;
            }
            
            .stats-middle-pane {
                width: 140px;
            }
            
            .stats-box {
                min-height: 45px;
                padding: 5px;
            }
            
            .stats-label {
                font-size: 11px;
            }
            
            .stats-value {
                font-size: 16px;
            }
            
            .math-box.box-3 {
                min-width: 250px;
                padding: 6px 5px;
            }
            
            .math-box.box-3.compact-mode {
                min-width: 230px;
                padding: 6px 4px;
            }
            
            .math-box.box-3.compact-mode .box-text-stack {
                min-width: 140px;
                margin-right: 5px;
            }
            
            .math-box.box-3.compact-mode .results-container {
                margin-left: 5px;
                gap: 5px;
            }
            
            .box-text-stack {
                font-size: 11px;
                margin-right: 8px;
                min-width: 130px;
            }
            
            .num, .den {
                font-size: 14px;
            }
            
            .arrow {
                font-size: 24px;
            }
            
            .result-final {
                font-size: 18px;
            }
            
            .result-fraction {
                min-width: 35px;
            }
            
            .result-fraction .num,
            .result-fraction .den {
                font-size: 14px;
            }
            
            #top-panel {
                height: calc(20vh - (0 * var(--cube-height)) + var(--header-increase));
                min-height: calc(180px - (0 * var(--cube-height)) + var(--header-increase));
            }
            
            .progress-wrapper-vertical {
                width: 65px;
                height: 140px;
            }
            
            .pct-label {
                font-size: 28px;
            }
            
            .model-name {
                font-size: 20px;
            }
            
            #render-area {
                min-height: 320px;
                max-height: 45vh;
                height: 45vh;
                padding: 15px;
            }
            
            .box.model-A, .box.model-B, .box.model-C {
                width: 85px;
                height: 85px;
            }
            
            .box.model-D {
                width: 65px;
                height: 75px;
            }
            
            #grid-container {
                gap: 15px;
                padding: 18px;
            }
            
            #designer-credit {
                font-size: 20px;
                padding: 12px;
            }
            
            #instructions {
                font-size: 18px;
                padding: 10px 15px;
            }
        }

        @media (max-width: 768px) {
            #app-container {
                padding: 3px;
            }
            
            #control-bar {
                padding: 6px 8px;
                gap: 4px;
                padding-right: 120px;
                height: 55px;
            }
            
            .control-section {
                gap: 3px;
            }
            
            .separator {
                margin: 0 1px;
            }
            
            .shape-label, .control-mode-label {
                margin: 0 1px;
                font-size: 14px;
            }
            
            #main-menu-btn {
                top: 3px;
                right: 3px;
                padding: 5px 10px;
                font-size: 11px;
                min-width: 80px;
                height: 34px;
            }
            
            .mode-btn, .model-btn {
                padding: 5px 8px;
                font-size: 12px;
                min-width: 50px;
                height: 38px;
            }
            
            #header-section {
                flex-direction: column;
                height: auto;
                min-height: calc(280px + (2.5 * var(--cube-height)));
            }
            
            #camera-wrapper {
                width: 100%;
                height: 110px;
            }
            
            .stats-middle-pane {
                width: 100%;
                height: auto;
                padding: 8px;
                margin: 8px 0;
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: space-around;
            }
            
            .stats-box {
                flex: 1;
                min-width: 120px;
                margin: 4px;
                padding: 6px;
            }
            
            .stats-label {
                font-size: 11px;
            }
            
            .stats-value {
                font-size: 15px;
            }
            
            .stats-left-pane {
                width: 100%;
                min-width: unset;
                height: auto;
                padding: 8px;
            }
            
            .math-content {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto auto;
                gap: 8px;
            }
            
            .math-box.box-1,
            .math-box.box-2,
            .math-box.box-3,
            .math-box.box-4 {
                grid-column: 1;
            }
            
            .math-box.box-1 { grid-row: 1; }
            .math-box.box-2 { grid-row: 2; }
            .math-box.box-3 { 
                grid-row: 3; 
                min-width: 95%;
            }
            .math-box.box-4 { 
                grid-row: 4; 
                min-width: 95%;
            }
            
            .math-box.box-3.compact-mode {
                min-width: 92%;
                padding: 6px 4px;
            }
            
            .math-box.box-3.compact-mode .box-text-stack {
                min-width: 130px;
                margin-right: 4px;
            }
            
            .math-box.box-3.compact-mode .results-container {
                margin-left: 4px;
                gap: 4px;
            }
            
            .math-box.box-3.compact-mode .result-final {
                font-size: 16px;
            }
            
            .arrow {
                transform: rotate(90deg) scaleX(1);
                font-size: 22px;
            }
            
            #render-area {
                min-height: 280px;
                max-height: 40vh;
                height: 40vh;
                padding: 12px;
            }
            
            #top-panel {
                height: calc(22vh - (0 * var(--cube-height)) + var(--header-increase));
                min-height: calc(170px - (0 * var(--cube-height)) + var(--header-increase));
            }
            
            .header-box {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .exercise-card {
                padding: 6px;
            }
            
            .model-name {
                font-size: 18px;
                height: 22px;
                margin-top: 8px;
            }
            
            .progress-container {
                min-height: 150px;
            }
            
            .progress-wrapper-vertical {
                width: 60px;
                height: 130px;
            }
            
            .pct-label {
                font-size: 26px;
                height: 30px;
            }
            
            .btn-action {
                padding: 7px 10px;
                font-size: 11px;
                min-width: 70px;
            }
            
            .box.model-A, .box.model-B, .box.model-C {
                width: 70px;
                height: 70px;
            }
            
            .box.model-D {
                width: 55px;
                height: 65px;
            }
            
            #grid-container {
                gap: 12px;
                padding: 15px;
            }
            
            #designer-credit {
                font-size: 18px;
                padding: 10px;
            }
            
            #instructions {
                font-size: 16px;
                padding: 8px 12px;
            }
        }
        
        @media (max-width: 480px) {
            #main-menu-btn {
                min-width: 70px;
                font-size: 10px;
                padding: 4px 8px;
            }
            
            #control-bar {
                padding-right: 100px;
            }
            
            .math-box.box-3.compact-mode .box-text-stack {
                min-width: 110px;
                font-size: 10px;
            }
            
            .math-box.box-3.compact-mode .result-final {
                font-size: 14px;
            }
            
            .math-box.box-3.compact-mode .result-fraction {
                min-width: 30px;
            }
            
            .math-box.box-3.compact-mode .result-fraction .num,
            .math-box.box-3.compact-mode .result-fraction .den {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>

<button id="main-menu-btn" onclick="resetAllAndGoHome()">üè† ÿßŸÑŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</button>

<div id="visual-cursor"></div>

<div id="app-container">
    <div id="control-bar">
        <div class="control-section">
            <span class="shape-label">ÿßŸÑÿ¥ŸÉŸÑ :</span>
            <button class="model-btn active" onclick="setModel('A')" id="btn-model-A">( A )</button>
            <button class="model-btn" onclick="setModel('B')" id="btn-model-B">( B )</button>
            <button class="model-btn" onclick="setModel('C')" id="btn-model-C">( C )</button>
            <button class="model-btn" onclick="setModel('D')" id="btn-model-D">( D )</button>
            <span class="separator">‚ÜîÔ∏è</span>
            <span class="control-mode-label" id="control-mode-label">ÿßŸÑÿ™ÿ≠ŸÉŸÖ :</span>
        </div>
        <div class="control-section">
            <button class="mode-btn active" onclick="setMode('touch')" id="btn-touch">üëÜ ÿßŸÑŸÑŸÖÿ≥</button>
            <button class="mode-btn" onclick="setMode('mouse')" id="btn-mouse">üñ±Ô∏è ÿßŸÑŸÖÿßŸàÿ≥</button>
            <button class="mode-btn camera-btn" onclick="setMode('camera')" id="btn-camera">üì∑ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß</button>
        </div>
    </div>

    <div id="header-section">
        <div id="camera-wrapper">
            <video id="camera-feed" autoplay playsinline muted></video>
        </div>

        <div class="stats-middle-pane">
            <div class="stats-title">ÿßŸÑÿ•ÿ≠ÿµÿßÿ°</div>
            <div class="stats-box">
                <div class="stats-label">ÿπÿØÿØ ÿßŸÑŸÖÿ±ÿ®ÿπÿßÿ™ ÿßŸÑŸÉŸÑŸä : </div>
                <div class="stats-value" id="val-total">25</div>
            </div>
            <div class="stats-box">
                <div class="stats-label">ÿπÿØÿØ ÿßŸÑŸÖÿ±ÿ®ÿπÿßÿ™ ÿßŸÑŸÖÿ≠ÿØÿØÿ© : </div>
                <div class="stats-value" id="val-selected">0</div>
            </div>
            <div class="stats-box">
                <div class="stats-label">ÿßŸÑŸÜÿ≥ÿ®ÿ© ÿßŸÑŸÖÿ¶ŸàŸäÿ© : </div>
                <div class="stats-value" id="val-percentage">0%</div>
            </div>
        </div>

        <div class="stats-left-pane">
            <div class="math-title">
                <span>ÿßŸÑÿπŸÖŸÑŸäŸëÿ© ÿßŸÑÿ≠ÿ≥ÿßÿ®ŸäŸëÿ© ÿ®ÿßŸÑÿ™ŸÅÿµŸäŸÑ</span>
                <span id="current-model-name" style="color: #ff0000; font-size: 15px; font-weight: bold; text-shadow: 0 0 3px rgba(255,0,0,0.3);">ÿßŸÑÿ¥ŸÉŸÑ ( A )</span>
            </div>
            <div id="math-display" class="math-content">
                <div style="text-align: center; color: #aaa; padding: 25px 12px; grid-column: 1 / -1;">
                    <div style="font-size: 18px; margin-bottom: 10px;">üëà</div>
                    <div style="font-size: 14px;">ÿßÿÆÿ™ÿ± ŸÖÿ±ÿ®ÿπŸãÿß ŸÑÿ®ÿØÿ° ÿßŸÑÿ≠ÿ≥ÿßÿ®</div>
                    <div style="font-size: 11px; margin-top: 6px; color: #888;">ÿ≥ŸàŸÅ ÿ™ÿ∏Ÿáÿ± ŸáŸÜÿß ÿßŸÑÿπŸÖŸÑŸäÿ© ÿßŸÑÿ≠ÿ≥ÿßÿ®Ÿäÿ© ÿ®ÿßŸÑÿ™ŸÅÿµŸäŸÑ</div>
                </div>
            </div>
        </div>
    </div>

    <div id="top-panel">
        <div class="header-box" id="cards-container"></div>
    </div>

    <div id="render-area">
        <div id="celebration-message">
            <div>ŸÖŸÖÿ™ÿßÿ≤ Ÿàÿ£ÿ≠ÿ≥ŸÜÿ™ Ÿäÿß ÿ®ÿ∑ŸÑ</div>
            <div>‚ú®‚ù§Ô∏èüéÅü§ç‚≠êüèÖüé∂üíéüåôüèÜ</div>
        </div>
        <div id="grid-container"></div>
    </div>

    <div id="bottom-info-bar">
        <div id="designer-credit">ÿ™ÿµŸÖŸäŸÖ ÿßŸÑŸÖŸáŸÜÿØÿ≥ : ÿ≤ŸäŸÜ ÿßŸÑÿπÿßÿ®ÿØŸäŸÜ ŸÖÿµÿ∑ŸÅŸâ ≈ΩƒÖ√´≈ã</div>
        <div id="instructions">ÿßÿÆÿ™ÿ± ÿßŸÑÿ¥ŸÉŸÑ ÿ´ŸÖ ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ Ÿàÿßÿ∂ÿ∫ÿ∑ "ÿßÿ®ÿØÿ£"</div>
    </div>
</div>

<script>
    const emojis = [
        'ü¶ã', '‚ù§Ô∏è', 'üéä', 'üé∂', 'üéâ', 'üéà', 'üéÅ', 'üíõ', 'üéÄ', 'üå∏', 'üíô',
        'üåû', 'üïäÔ∏è', 'üå∫', '‚≠ê', 'üíú', 'üç≠', 'üíö', 'üßÅ', 'ü§ç', 'üß∏', 'üåô',
        'üî•', 'üíé', 'üê•', 'üç¨', 'üê∂', 'üí†', 'üïäÔ∏è', 'ü¶ú', 'üåº', 'ü™ê', 'üê¨',
        '‚òòÔ∏è', 'ü¶Ö', 'üå∏', 'üåù', 'üêü', 'üíê', 'üîÆ', '‚òÉÔ∏è', 'üêâ', '‚ú®'
    ];

    function getUniqueEmojis(count) {
        const shuffled = [...emojis].sort(() => Math.random() - 0.5);
        if (count <= shuffled.length) {
            return shuffled.slice(0, count);
        } else {
            let result = [];
            while (result.length < count) {
                const temp = [...emojis].sort(() => Math.random() - 0.5);
                result = result.concat(temp);
            }
            return result.slice(0, count);
        }
    }

    let config = { cols: 5, rows: 5, goal: 9, shape: '‚≠ê' };
    let score = 0, gameActive = true;
    let lastX = window.innerWidth / 2, lastY = window.innerHeight / 2;
    let hoverTarget = null, hoverStartTime = 0;
    const DWELL_TIME = 800;
    const SMOOTHING = 0.05;
    
    let currentMode = 'touch';
    let cameraStream = null;
    let trackingActive = false;
    let lastValidPosition = { x: window.innerWidth / 2, y: window.innerHeight / 2 };

    let lastSoundTime = 0;
    const soundInterval = 150;
    
    let lastClickTime = 0;
    let clickCount = 0;
    
    let audioCtx = null;
    function getAudioContext() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
        return audioCtx;
    }

    function resetAllAndGoHome() {
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
            cameraStream = null;
        }
        
        Object.keys(models).forEach(id => {
            models[id].solved = 0;
            models[id].selections = [];
        });
        
        currentModel = 'A';
        score = 0;
        gameActive = true;
        hoverTarget = null;
        lastClickTime = 0;
        clickCount = 0;
        
        setModel('A');
        startEx('A', false);
        
        document.getElementById('celebration-message').style.display = 'none';
        
        const box4 = document.querySelector('.math-box.box-4');
        if (box4) box4.classList.remove('visible');
        
        setTimeout(() => {
            location.href = 'ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©.html';
        }, 300);
    }

    const moveFrequencies = [440, 494, 523, 587, 659, 698, 784];
    function playMoveSound() {
        const now = Date.now();
        if (now - lastSoundTime < soundInterval) return;
        lastSoundTime = now;
        
        const freq = moveFrequencies[Math.floor(Math.random() * moveFrequencies.length)];
        const type = ['sine', 'triangle', 'sawtooth'][Math.floor(Math.random() * 3)];
        playNote(freq, type, 0.15, 0.08);
    }

    function playNote(freq, type = 'sine', duration = 0.2, vol = 0.1) {
        try {
            const ctx = getAudioContext();
            const osc = ctx.createOscillator();
            const g = ctx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, ctx.currentTime);
            g.gain.setValueAtTime(vol, ctx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);
            osc.connect(g); g.connect(ctx.destination);
            osc.start(); osc.stop(ctx.currentTime + duration);
        } catch(e) {}
    }

    function playSuccessSound() {
        playNote(880, 'sine', 0.2, 0.18);
    }

    function playWinSound() {
        const notes = [659, 784, 880, 1047, 1175, 1047, 880, 784, 659, 784, 880, 1047];
        notes.forEach((n, i) => {
            const delay = i * 120;
            setTimeout(() => playNote(n, 'square', 0.2, 0.2), delay);
            setTimeout(() => playNote(n * 1.5, 'sine', 0.3, 0.15), delay + 50);
        });
    }

    const sparkleColors = ['#ff6b6b', '#4ecdc4', '#ffe66d', '#ff9f1c', '#6a0572', '#1a936f', '#ff70a6'];
    function createSparkle(x, y) {
        const s = document.createElement('div');
        s.className = 'sparkle';
        const color = sparkleColors[Math.floor(Math.random() * sparkleColors.length)];
        s.style.background = `radial-gradient(circle, ${color} 0%, transparent 100%)`;
        s.style.left = x + 'px';
        s.style.top = y + 'px';
        document.body.appendChild(s);
        setTimeout(() => s.remove(), 800);
    }

    function createGlowTrail(x, y) {
        const t = document.createElement('div');
        t.className = 'glow-trail';
        const color = sparkleColors[Math.floor(Math.random() * sparkleColors.length)];
        t.style.background = `rgba(${parseInt(color.slice(1,3),16)}, ${parseInt(color.slice(3,5),16)}, ${parseInt(color.slice(5,7),16)}, 0.7)`;
        t.style.left = x + 'px';
        t.style.top = y + 'px';
        document.body.appendChild(t);
        setTimeout(() => t.remove(), 1000);
    }

    function spawnCelebration(x, y, count = 40) {
        const uniqueEmojis = getUniqueEmojis(count);
        for (let i = 0; i < count; i++) {
            const el = document.createElement('div');
            el.className = 'emoji-particle';
            el.innerText = uniqueEmojis[i % uniqueEmojis.length];
            el.style.left = x + 'px'; 
            el.style.top = y + 'px';
            document.body.appendChild(el);
            
            const angle = Math.random() * Math.PI * 2;
            const distance = 200 + Math.random() * 400;
            const tx = Math.cos(angle) * distance;
            const ty = Math.sin(angle) * distance - 150;
            const rot = Math.random() * 1080 - 540;
            
            el.style.setProperty('--tx', tx + 'px');
            el.style.setProperty('--ty', ty + 'px');
            el.style.setProperty('--rot', rot + 'deg');
            
            setTimeout(() => el.remove(), 3000);
        }
    }

    function moveCursor(x, y, instant = false) {
        const cursor = document.getElementById('visual-cursor');
        
        if (instant) {
            lastX = x; lastY = y;
            lastValidPosition = { x, y };
        } else {
            lastX += (x - lastX) * SMOOTHING;
            lastY += (y - lastY) * SMOOTHING;
            lastValidPosition = { x: lastX, y: lastY };
        }
        
        cursor.style.left = lastX + 'px';
        cursor.style.top = lastY + 'px';
        
        if (!instant) {
            playMoveSound();
            if (Math.random() > 0.6) createSparkle(lastX, lastY);
            if (Math.random() > 0.7) createGlowTrail(lastX, lastY);
        }
        
        checkHover(lastX, lastY);
    }

    function checkHover(x, y) {
        if (!gameActive) return;
        
        const el = document.elementFromPoint(x, y);
        const box = el?.closest('.box');
        
        if (box && !box.classList.contains('selected')) {
            if (hoverTarget !== box) {
                clearHoverRing();
                hoverTarget = box;
                hoverStartTime = Date.now();
            }
            
            const elapsed = Date.now() - hoverStartTime;
            const progress = Math.min((elapsed / DWELL_TIME) * 100, 100);
            
            let ring = box.querySelector('.wait-ring');
            if (!ring) {
                ring = document.createElement('div');
                ring.className = 'wait-ring';
                box.appendChild(ring);
            }
            ring.style.clipPath = `inset(${100 - progress}% 0 0 0)`;
            
            if (elapsed >= DWELL_TIME) {
                selectBox(box, x, y);
            }
        } else {
            clearHoverRing();
            hoverTarget = null;
        }
    }

    function clearHoverRing() {
        if (hoverTarget) {
            const ring = hoverTarget.querySelector('.wait-ring');
            if (ring) ring.remove();
        }
    }

    function selectBox(box, x, y) {
        if (!gameActive || box.classList.contains('selected')) return;
        
        if (score >= config.goal) {
            return;
        }
        
        clearHoverRing();
        hoverTarget = null;
        
        box.classList.add('selected');
        score++;
        
        const boxes = document.querySelectorAll('.box');
        const index = Array.from(boxes).indexOf(box);
        if (!models[currentModel].selections.includes(index)) {
            models[currentModel].selections.push(index);
            models[currentModel].solved = score;
        }
        
        updateStats();
        playSuccessSound();
        spawnCelebration(x || box.getBoundingClientRect().left + 42, y || box.getBoundingClientRect().top + 42, 20);

        if (score >= config.goal) {
            gameActive = false;
            setTimeout(() => {
                document.getElementById('celebration-message').style.display = 'block';
                playWinSound();
                spawnCelebration(window.innerWidth/2, window.innerHeight/2, 80);
                
                const box4 = document.querySelector('.math-box.box-4');
                if (box4) box4.classList.add('visible');
            }, 400);
        }
        
        updateMathDisplay();
        updateProgressBar(currentModel);
    }

    function updateStats() {
        const totalBoxes = config.rows * config.cols;
        document.getElementById('val-total').innerText = totalBoxes;
        document.getElementById('val-selected').innerText = score;
        
        const percentage = score > 0 ? (score / totalBoxes) * 100 : 0;
        const roundedPercentage = Math.round(percentage);
        document.getElementById('val-percentage').innerText = `${roundedPercentage}%`;
    }

    function setMode(mode) {
        currentMode = mode;
        
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + mode).classList.add('active');
        
        if (mode !== 'camera') {
            stopCamera();
        }
        
        const instructions = {
            'touch': `üëÜ ÿßŸÑŸÖÿ≥ ÿßŸÑŸÖÿ±ÿ®ÿπ ŸÖÿ±ÿ™ŸäŸÜ ŸÖÿ™ÿ™ÿßŸÑŸäÿ™ŸäŸÜ ŸÑÿ™ÿ≠ÿØŸäÿØŸá`,
            'mouse': `üñ±Ô∏è ÿßŸÜŸÇÿ± ŸÖÿ±ÿ™ŸäŸÜ ÿπŸÑŸâ ÿßŸÑŸÖÿ±ÿ®ÿπ ŸÑÿ™ÿ≠ÿØŸäÿØŸá`,
            'camera': `üì∑ ÿ≠ÿ±ŸÉ ŸäÿØŸÉ ÿ£ŸÖÿßŸÖ ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß ŸÑŸÑÿ™ÿ≠ŸÉŸÖ ÿ®ÿßŸÑŸÖÿ§ÿ¥ÿ±`
        };
        document.getElementById('instructions').textContent = instructions[mode];
        
        if (mode === 'camera') {
            startCamera();
        }
        
        updateControlLabelColor();
    }

    function updateControlLabelColor() {
        const label = document.getElementById('control-mode-label');
        if (currentMode === 'touch') {
            label.style.color = '#00ffcc';
        } else if (currentMode === 'mouse') {
            label.style.color = '#ffffff';
        } else if (currentMode === 'camera') {
            label.style.color = '#ff0';
        }
    }

    async function startCamera() {
        document.getElementById('camera-wrapper').style.display = 'block';
        try {
            cameraStream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'user', width: 320, height: 240 }
            });
            
            const video = document.getElementById('camera-feed');
            video.srcObject = cameraStream;
            
            video.onloadedmetadata = () => {
                video.play();
                startColorTracking();
            };
        } catch (err) {
            document.getElementById('camera-wrapper').innerHTML = 
                '<div style="color:white; text-align:center; padding:15px; font-size:16px; background:#600;">‚ö†Ô∏è ÿßŸÑŸÉÿßŸÖŸäÿ±ÿß ŸÑÿß ÿ™ÿπŸÖŸÑ<br>ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÑŸÖÿ≥ ÿ£Ÿà ÿßŸÑŸÖÿßŸàÿ≥</div>';
        }
    }

    function stopCamera() {
        trackingActive = false;
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
            cameraStream = null;
        }
        document.getElementById('camera-wrapper').style.display = 'none';
    }

    function startColorTracking() {
        trackingActive = true;
        const video = document.getElementById('camera-feed');
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        canvas.width = 160;
        canvas.height = 120;
        
        function track() {
            if (!trackingActive || currentMode !== 'camera') return;
            
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            let sumX = 0, sumY = 0, count = 0;
            
            for (let y = 0; y < canvas.height; y += 2) {
                for (let x = 0; x < canvas.width; x += 2) {
                    const i = (y * canvas.width + x) * 4;
                    const r = data[i], g = data[i+1], b = data[i+2];
                    
                    if (isSkinColor(r, g, b)) {
                        sumX += x;
                        sumY += y;
                        count++;
                    }
                }
            }
            
            if (count > 50) {
                const avgX = sumX / count;
                const avgY = sumY / count;
                
                const screenX = (1 - avgX / canvas.width) * window.innerWidth;
                const screenY = (avgY / canvas.height) * window.innerHeight;
                
                moveCursor(screenX, screenY);
                lastValidPosition = { x: screenX, y: screenY };
            } else {
                moveCursor(lastValidPosition.x, lastValidPosition.y, true);
            }
            
            requestAnimationFrame(track);
        }
        
        track();
    }

    function isSkinColor(r, g, b) {
        const max = Math.max(r, g, b);
        const min = Math.min(r, g, b);
        
        return r > 95 && g > 40 && b > 20 &&
               r > g && r > b &&
               (max - min) > 15 &&
               Math.abs(r - g) > 15;
    }

    document.addEventListener('touchstart', (e) => {
        if (currentMode !== 'touch') return;
        const touch = e.touches[0];
        moveCursor(touch.clientX, touch.clientY, true);
        
        const now = Date.now();
        if (now - lastClickTime < 300) {
            clickCount++;
            if (clickCount === 2) {
                const el = document.elementFromPoint(touch.clientX, touch.clientY);
                const box = el?.closest('.box');
                if (box && !box.classList.contains('selected')) {
                    selectBox(box, touch.clientX, touch.clientY);
                }
                clickCount = 0;
            }
        } else {
            clickCount = 1;
        }
        lastClickTime = now;
    }, { passive: true });

    document.addEventListener('touchmove', (e) => {
        if (currentMode !== 'touch') return;
        const touch = e.touches[0];
        moveCursor(touch.clientX, touch.clientY);
    }, { passive: true });

    document.addEventListener('mousemove', (e) => {
        if (currentMode !== 'mouse') return;
        moveCursor(e.clientX, e.clientY);
    });

    document.addEventListener('click', (e) => {
        if (currentMode !== 'mouse') return;
        const now = Date.now();
        if (now - lastClickTime < 300) {
            clickCount++;
            if (clickCount === 2) {
                const el = document.elementFromPoint(e.clientX, e.clientY);
                const box = el?.closest('.box');
                if (box && !box.classList.contains('selected')) {
                    selectBox(box, e.clientX, e.clientY);
                }
                clickCount = 0;
            }
        } else {
            clickCount = 1;
        }
        lastClickTime = now;
    });

    let models = {
        'A': { 
            name: "ÿßŸÑÿ¥ŸÉŸÑ ( A )",
            rows: 5, 
            cols: 5, 
            goal: 9, 
            shape: '‚≠ê',
            color: '#2ecc71',
            solved: 0,
            selections: []
        },
        'B': { 
            name: "ÿßŸÑÿ¥ŸÉŸÑ ( B )",
            rows: 5, 
            cols: 6, 
            goal: 12, 
            shape: 'üíé',
            color: '#e67e22',
            solved: 0,
            selections: []
        },
        'C': { 
            name: "ÿßŸÑÿ¥ŸÉŸÑ ( C )",
            rows: 4, 
            cols: 5, 
            goal: 13, 
            shape: '‚ù§Ô∏è',
            color: '#3498db',
            solved: 0,
            selections: []
        },
        'D': { 
            name: "ÿßŸÑÿ¥ŸÉŸÑ ( D )",
            rows: 5, 
            cols: 10, 
            goal: 14, 
            shape: 'üèÜ',
            color: '#9b59b6',
            solved: 0,
            selections: []
        }
    };
    
    let currentModel = 'A';

    function setModel(model) {
        currentModel = model;
        
        document.querySelectorAll('.model-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-model-' + model).classList.add('active');
        
        document.getElementById('current-model-name').innerText = models[model].name;
        
        document.querySelectorAll('.exercise-card').forEach(c => c.classList.remove('active'));
        document.getElementById('card-' + model).classList.add('active');
        
        startEx(model, true);
    }

    function init() {
        renderCards();
        startEx('A', true);
        
        const cursor = document.getElementById('visual-cursor');
        cursor.style.left = (window.innerWidth / 2) + 'px';
        cursor.style.top = (window.innerHeight / 2) + 'px';
        lastValidPosition = { x: window.innerWidth / 2, y: window.innerHeight / 2 };

        setMode('touch');
        updateControlLabelColor();
        
        window.addEventListener('resize', () => {
            if (currentModel) {
                buildGrid();
            }
        });
        
        if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
            document.querySelector('meta[name="viewport"]').content = "width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no";
        }
    }

    function updateMathDisplay() {
        if (score === 0) {
            document.getElementById('math-display').innerHTML = `
                <div style="text-align: center; color: #aaa; padding: 25px 12px; grid-column: 1 / -1;">
                    <div style="font-size: 18px; margin-bottom: 10px;">üëà</div>
                    <div style="font-size: 14px;">ÿßÿÆÿ™ÿ± ŸÖÿ±ÿ®ÿπŸãÿß ŸÑÿ®ÿØÿ° ÿßŸÑÿ≠ÿ≥ÿßÿ®</div>
                    <div style="font-size: 11px; margin-top: 6px; color: #888;">ÿ≥ŸàŸÅ ÿ™ÿ∏Ÿáÿ± ŸáŸÜÿß ÿßŸÑÿπŸÖŸÑŸäÿ© ÿßŸÑÿ≠ÿ≥ÿßÿ®Ÿäÿ© ÿ®ÿßŸÑÿ™ŸÅÿµŸäŸÑ</div>
                </div>
            `;
            return;
        }
        
        const totalBoxes = config.rows * config.cols;
        const percentage = (score / totalBoxes) * 100;
        const roundedPercentage = Math.round(percentage);
        
        let step2Num, step2Den, step3Num, step3Den;
        
        switch(currentModel) {
            case 'A':
                step2Num = score * 4;
                step2Den = totalBoxes * 4;
                break;
            case 'B':
                step2Num = score / 3;
                step2Den = totalBoxes / 3;
                step3Num = step2Num * 10;
                step3Den = step2Den * 10;
                break;
            case 'C':
                step2Num = score * 5;
                step2Den = totalBoxes * 5;
                break;
            case 'D':
                step2Num = score * 2;
                step2Den = totalBoxes * 2;
                break;
        }
        
        if (step2Num && step2Den) {
            step2Num = Math.round(step2Num * 100) / 100;
            step2Den = Math.round(step2Den * 100) / 100;
        }
        if (step3Num && step3Den) {
            step3Num = Math.round(step3Num);
            step3Den = Math.round(step3Den);
        }
        
        let mathHTML = '';
        
        if (currentModel === 'B') {
            mathHTML = `
                <div class="math-box box-1">
                    <div class="step-number">1</div>
                    <div class="box-text-stack">
                        <span class="box-text">ÿßŸÑÿ®ÿ≥ÿ∑ ÿπÿØÿØ ÿßŸÑŸÖÿ±ÿ®ÿπÿßÿ™ ÿßŸÑŸÖÿ≠ÿØÿØÿ©</span>
                        <span class="box-text">ÿßŸÑŸÖŸÇÿßŸÖ ÿπÿØÿØ ÿßŸÑŸÖÿ±ÿ®ÿπÿßÿ™ ÿßŸÑŸÉŸÑŸä</span>
                    </div>
                    <div class="fraction-container">
                        <div class="fraction"><span class="num">${score}</span><span class="den">${totalBoxes}</span></div>
                    </div>
                </div>

                <div class="math-box box-2">
                    <div class="step-number">2</div>
                    <div class="box-text-stack">
                        <span class="box-text">ŸÜŸÇÿ≥ŸÖ ÿßŸÑÿ®ÿ≥ÿ∑ ŸàÿßŸÑŸÖŸÇÿßŸÖ</span>
                        <span class="box-text">ÿπŸÑŸâ ÿßŸÑÿ±ŸÇŸÖ ( 3 ) ŸÅÿ™ÿµÿ®ÿ≠</span>
                    </div>
                    <div class="fraction-container">
                        <div class="fraction"><span class="num">${step2Num}</span><span class="den">${step2Den}</span></div>
                    </div>
                </div>

                <div class="math-box box-3 compact-mode">
                    <div class="step-number">3</div>
                    <div class="box-text-stack">
                        <span class="box-text">ŸÜÿ∂ÿ±ÿ® ÿßŸÑÿ®ÿ≥ÿ∑ ŸàÿßŸÑŸÖŸÇÿßŸÖ ÿ®ÿßŸÑÿ±ŸÇŸÖ ( 10 )</span>
                        <span class="box-text">ÿ´ŸÖ ŸÜŸÇÿ≥ŸÖ ÿßŸÑÿ®ÿ≥ÿ∑ ÿπŸÑŸâ ÿßŸÑŸÖŸÇÿßŸÖ ŸÅŸäÿµÿ®ÿ≠</span>
                    </div>
                    <div class="results-container">
                        <div class="result-fraction">
                            <span class="num">${step3Num}</span>
                            <span class="den">${step3Den}</span>
                        </div>
                        <span style="color: var(--orange); font-size: 16px; font-weight: bold;">=</span>
                        <div class="result-final">${roundedPercentage} %</div>
                    </div>
                </div>
                
                <div class="math-box box-4 ${score >= config.goal ? 'visible' : ''}">
                    <div class="step-number">4</div>
                    <div class="box-text-stack">
                        <span class="box-text">ŸÜÿ≥ÿ™ŸÜÿ™ÿ¨ ÿßŸÑŸÜÿ≥ÿ®ÿ© ÿßŸÑŸÖÿ¶ŸàŸäÿ© ÿßŸÑŸÖÿ≠ŸÇŸÇÿ© ${roundedPercentage}%</span>
                        <span class="box-text">ÿ™ÿ≥ÿßŸàŸä ÿ™ŸÑŸàŸäŸÜ ${score} ŸÖÿ±ÿ®ÿπÿßŸã ŸÖŸÜ ${totalBoxes} ŸÖÿ±ÿ®ÿπ</span>
                    </div>
                </div>
            `;
        } else {
            mathHTML = `
                <div class="math-box box-1">
                    <div class="step-number">1</div>
                    <div class="box-text-stack">
                        <span class="box-text">ÿßŸÑÿ®ÿ≥ÿ∑ ÿπÿØÿØ ÿßŸÑŸÖÿ±ÿ®ÿπÿßÿ™ ÿßŸÑŸÖÿ≠ÿØÿØÿ©</span>
                        <span class="box-text">ÿßŸÑŸÖŸÇÿßŸÖ ÿπÿØÿØ ÿßŸÑŸÖÿ±ÿ®ÿπÿßÿ™ ÿßŸÑŸÉŸÑŸä</span>
                    </div>
                    <div class="fraction-container">
                        <div class="fraction"><span class="num">${score}</span><span class="den">${totalBoxes}</span></div>
                    </div>
                </div>

                <div class="math-box box-2">
                    <div class="step-number">2</div>
                    <div class="box-text-stack">
                        <span class="box-text">${currentModel === 'A' ? 'ŸÜÿ∂ÿ±ÿ® ÿßŸÑÿ®ÿ≥ÿ∑ ŸàÿßŸÑŸÖŸÇÿßŸÖ' : currentModel === 'C' ? 'ŸÜÿ∂ÿ±ÿ® ÿßŸÑÿ®ÿ≥ÿ∑ ŸàÿßŸÑŸÖŸÇÿßŸÖ' : 'ŸÜÿ∂ÿ±ÿ® ÿßŸÑÿ®ÿ≥ÿ∑ ŸàÿßŸÑŸÖŸÇÿßŸÖ'}</span>
                        <span class="box-text">${currentModel === 'A' ? 'ÿ®ÿßŸÑÿ±ŸÇŸÖ ( 4 ) ŸÅÿ™ÿµÿ®ÿ≠' : currentModel === 'C' ? 'ÿ®ÿßŸÑÿ±ŸÇŸÖ ( 5 ) ŸÅÿ™ÿµÿ®ÿ≠' : 'ÿ®ÿßŸÑÿ±ŸÇŸÖ ( 2 ) ŸÅÿ™ÿµÿ®ÿ≠'}</span>
                    </div>
                    <div class="fraction-container">
                        <div class="fraction"><span class="num">${step2Num}</span><span class="den">${step2Den}</span></div>
                    </div>
                </div>

                <div class="math-box box-3">
                    <div class="step-number">3</div>
                    <div class="box-text-stack">
                        <span class="box-text">ŸÜŸÇÿ≥ŸÖ ÿßŸÑÿ®ÿ≥ÿ∑ ÿπŸÑŸâ ÿßŸÑŸÖŸÇÿßŸÖ</span>
                        <span class="box-text">ŸÅŸäÿµÿ®ÿ≠ ÿßŸÑŸÜÿßÿ™ÿ¨ ÿßŸÑŸÜŸáÿßÿ¶Ÿä</span>
                    </div>
                    <div class="result-final">${roundedPercentage} %</div>
                </div>
                
                <div class="math-box box-4 ${score >= config.goal ? 'visible' : ''}">
                    <div class="step-number">4</div>
                    <div class="box-text-stack">
                        <span class="box-text">ŸÜÿ≥ÿ™ŸÜÿ™ÿ¨ ÿßŸÑŸÜÿ≥ÿ®ÿ© ÿßŸÑŸÖÿ¶ŸàŸäÿ© ÿßŸÑŸÖÿ≠ŸÇŸÇÿ© ${roundedPercentage}%</span>
                        <span class="box-text">ÿ™ÿ≥ÿßŸàŸä ÿ™ŸÑŸàŸäŸÜ ${score} ŸÖÿ±ÿ®ÿπÿßŸã ŸÖŸÜ ${totalBoxes} ŸÖÿ±ÿ®ÿπ</span>
                    </div>
                </div>
            `;
        }
        
        document.getElementById('math-display').innerHTML = mathHTML;
    }

    function renderCards() {
        const container = document.getElementById('cards-container');
        container.innerHTML = '';
        
        Object.keys(models).forEach(id => {
            const isActive = id === currentModel;
            const model = models[id];
            const totalBoxes = model.rows * model.cols;
            const pct = Math.round((model.solved / model.goal) * 100);
            
            const card = document.createElement('div');
            card.className = `exercise-card ${isActive?'active':''}`;
            card.id = `card-${id}`;
            
            card.innerHTML = `
                <div class="model-name">${model.name}</div>
                <div class="progress-container">
                    <div class="progress-wrapper-vertical">
                        <div id="bar-${id}" class="progress-bar-vertical" style="background:${model.color}; height:${Math.min(pct, 100)}%"></div>
                    </div>
                    <div class="pct-label" id="txt-${id}">${Math.min(pct, 100)} %</div>
                </div>
                <div class="buttons-container">
                    <div class="top-buttons">
                        <button class="btn-action btn-start">ÿßÿ®ÿØÿ£</button>
                        <button class="btn-action btn-resume" id="res-${id}" style="${model.solved > 0 && model.solved < model.goal ? 'display:inline-block' : 'display:none'}">ÿßÿ≥ÿ™ÿ¶ŸÜÿßŸÅ</button>
                    </div>
                    <button class="btn-action btn-reset">ÿ•ÿπÿßÿØÿ© ÿ∂ÿ®ÿ∑</button>
                </div>
            `;
            
            container.appendChild(card);
            
            const btnStart = card.querySelector('.btn-start');
            const btnResume = card.querySelector('.btn-resume');
            const btnReset = card.querySelector('.btn-reset');
            
            btnStart.onclick = e => {
                e.stopPropagation();
                setModel(id);
                startEx(id, false);
            };
            
            btnResume.onclick = e => {
                e.stopPropagation();
                setModel(id);
                startEx(id, true);
            };
            
            btnReset.onclick = e => {
                e.stopPropagation();
                resetEx(id);
            };
            
            card.onclick = () => {
                if (currentModel !== id) {
                    setModel(id);
                }
            };
        });
    }

    function startEx(id, resume) {
        currentModel = id;
        const model = models[id];
        
        if (!resume) {
            model.solved = 0;
            model.selections = [];
            score = 0;
        } else {
            score = model.solved;
        }
        
        config = {
            rows: model.rows,
            cols: model.cols,
            goal: model.goal,
            shape: model.shape
        };
        
        gameActive = true;
        hoverTarget = null;
        clickCount = 0;
        lastClickTime = 0;
        document.getElementById('celebration-message').style.display = 'none';
        
        const box4 = document.querySelector('.math-box.box-4');
        if (box4) box4.classList.remove('visible');
        
        buildGrid();
        updateStats();
        updateMathDisplay();
        updateProgressBar(id);
        
        document.getElementById('res-'+id).style.display = 'none';
        
        Object.keys(models).forEach(otherId => {
            if (otherId !== id && models[otherId].solved > 0 && models[otherId].solved < models[otherId].goal) {
                document.getElementById('res-'+otherId).style.display = 'inline-block';
            }
        });
    }

    function buildGrid() {
        const grid = document.getElementById('grid-container');
        grid.innerHTML = '';
        
        const model = models[currentModel];
        
        let boxSize = 85;
        if (currentModel === 'A' || currentModel === 'B' || currentModel === 'C') {
            boxSize = 95;
            grid.style.gridTemplateColumns = `repeat(${model.cols}, ${boxSize}px)`;
        } else if (currentModel === 'D') {
            boxSize = 70;
            grid.style.gridTemplateColumns = `repeat(${model.cols}, ${boxSize}px)`;
        } else {
            grid.style.gridTemplateColumns = `repeat(${model.cols}, ${boxSize}px)`;
        }
        
        for (let i = 0; i < model.rows * model.cols; i++) {
            const box = document.createElement('div');
            box.className = `box model-${currentModel}`;
            
            const isSelected = model.selections.includes(i);
            
            if (isSelected) {
                box.classList.add('selected');
            }
            
            box.innerHTML = `<span class="shape">${config.shape}</span>`;
            
            box.onclick = function() {
                if (!this.classList.contains('selected') && gameActive && score < config.goal) {
                    selectBox(this);
                }
            };
            
            grid.appendChild(box);
        }
    }

    function updateProgressBar(id) {
        const model = models[id];
        const totalBoxes = model.rows * model.cols;
        const pct = Math.min(Math.round((model.solved / totalBoxes) * 100), 100);
        document.getElementById('bar-'+id).style.height = pct + '%';
        document.getElementById('txt-'+id).innerText = pct + ' %';
    }

    function resetEx(id) {
        models[id].solved = 0;
        models[id].selections = [];
        
        if (currentModel === id) {
            score = 0;
            gameActive = true;
            hoverTarget = null;
            clickCount = 0;
            lastClickTime = 0;
            document.getElementById('celebration-message').style.display = 'none';
            
            const box4 = document.querySelector('.math-box.box-4');
            if (box4) box4.classList.remove('visible');
            
            buildGrid();
            updateStats();
            updateMathDisplay();
        }
        
        updateProgressBar(id);
        document.getElementById('res-'+id).style.display = 'none';
    }

    document.addEventListener('click', () => getAudioContext(), { once: true });
    document.addEventListener('touchstart', () => getAudioContext(), { once: true });

    window.onload = init;
</script>

<script>
if (typeof getAudioContext === 'function') {
    const originalGetAudioContext = getAudioContext;
    getAudioContext = function() {
        if (!window.appSystem.audioContext) {
            window.appSystem.audioContext = originalGetAudioContext();
        }
        return window.appSystem.audioContext;
    };
}

function initAudioEx2() {
    if (!window.appSystem.audioContext) {
        window.appSystem.audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
}

document.addEventListener('click', initAudioEx2, { once: true });
document.addEventListener('touchstart', initAudioEx2, { once: true });

document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('main-menu-btn');
    if (btn && !btn.onclick) {
        btn.onclick = function(e) {
            e.preventDefault();
            if (window.goToMainMenu) {
                window.goToMainMenu();
            }
            return false;
        };
    }
});
</script>

<script src="system-config.js"></script>
<script src="data-manager.js"></script>
<script src="exercise-helper.js"></script>
</body>
</html>